<!doctype html>

<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Planning Poker - Pesar Historias</title>
<style>
  body { font-family: Inter, system-ui, Arial; margin:0; background:#0f1724; color:#e6eef8; }
  .container { max-width:900px; margin:24px auto; padding:20px; background:#111827; border-radius:8px; box-shadow: 0 6px 18px rgba(0,0,0,0.6);}
  h1 { margin:0 0 12px 0; font-size:20px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; }
  input, button, textarea { padding:10px 12px; border-radius:6px; border:1px solid #223047; background:#0b1220; color:#e6eef8; }
  button { cursor:pointer; border: none; background:#0ea5a4; color:#012; transition:0.2s; }
  button:hover { opacity:0.9; }
  button.secondary { background:#334155; color:#e6eef8; }
  .hidden { display:none; }
  .room-area { margin-top:16px; }
  .users { width:260px; border-right:1px solid #223047; padding-right:12px; }
  .main { flex:1; padding-left:12px; }
  .user-item { display:flex; justify-content:space-between; padding:6px 4px; border-radius:4px; margin-bottom:6px; background:transparent; }
  .vote-btn { padding:10px 12px; margin:6px; border-radius:6px; border:1px solid #223047; background:#061526; color:#e6eef8; cursor:pointer; }
  .vote-btn:disabled { opacity:0.35; cursor:not-allowed; }
  .toolbar { display:flex; gap:8px; margin-bottom:12px; }
  .small { font-size:13px; color:#9fb3c8; }
  .top { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
  .room-id { background:#071021; padding:6px 8px; border-radius:6px; font-family:monospace; }
  .center { text-align:center; }
  #historyList { background:#071021; padding:8px; border-radius:6px; max-height:180px; overflow-y:auto; font-size:14px; }
  .history-item { border-bottom:1px solid #223047; padding:6px 0; }
  .history-item:last-child { border-bottom:none; }
  .history-title { font-weight:bold; }
  .history-votes { color:#9fb3c8; font-size:13px; }
</style>
</head>
<body>
  <div class="container" id="app">
    
    <!-- Pantalla inicial -->
    <div id="home">
      <div class="top">
        <h1>Planning Poker ‚Äî Pesar Historias</h1>
        
      </div>

  <div class="row">
    <div style="flex:1; min-width:260px;">
      <label class="small">Tu nombre</label><br/>
      <input id="username" placeholder="Ej: Mar√≠a, Juan, Dev1" />
    </div>
    <div style="width:200px;">
      <label class="small">C√≥digo de sala (opcional)</label><br/>
      <input id="roomInput" placeholder="p ej: sprint-5" />
    </div>
  </div>

  <div style="margin-top:12px;" class="row">
    <button id="createBtn">Crear sala nueva</button>
    <button id="joinBtn" class="secondary">Ingresar a sala</button>
  </div>

  <div style="margin-top:20px;">
    <div class="small">Nota: al crear sala se genera un id aleatorio que compartes con el equipo.</div>
  </div>
</div>

<!-- Pantalla de la sala -->
<div id="room" class="hidden">
  <div class="top">
    <div>
      <h1 id="titleRoom">Sala</h1>
      <div class="small">Sala: <span id="roomId" class="room-id"></span> ‚Äî Usuario: <strong id="me"></strong></div>
    </div>
    <div class="center">
      <div class="toolbar">
        <button id="setTitleBtn">Guardar t√≠tulo</button>
        <button id="resetBtn" class="secondary">Reiniciar votaci√≥n</button>
        <button id="leaveBtn" class="secondary">Salir</button>
      </div>
    </div>
  </div>

  <div>
    <label class="small">T√≠tulo de la historia actual (HU)</label><br/>
    <input id="titleInput" placeholder="Ej: HU-102 Ajustar login m√≥vil" style="width:100%;margin-bottom:12px;" />
  </div>

  <div class="row room-area">
    <div class="users">
      <h3 style="margin-top:0">Conectados</h3>
      <div id="usersList"></div>

      <h3>Historial</h3>
      <div id="historyList"></div>
    </div>

    <div class="main">
      <h3 style="margin-top:0">Votaci√≥n</h3>
      <div id="info" class="small">Selecciona un valor.</div>
      <div id="buttons" style="margin-top:10px;"></div>
      <div id="chartContainer" style="width:100%; max-width:600px; height:400px; margin:auto;"></div>
    </div>
  </div>
</div>


  </div>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script>
(() => {
  const FIB = [1, 2, 3, 5, 8, 13, 21, 34];

  // üü¢ CAMBIA esto por tu URL real en Render
  const backendHost = "backpesanding.onrender.com"; 
  const wsProtocol = "wss";

  let ws = null, room = null, user = null;

  const el = (id) => document.getElementById(id);

  function showHome() {
    el("home").classList.remove("hidden");
    el("room").classList.add("hidden");
    if (ws) { try { ws.close(); } catch (e) {} ws = null; }
  }

  function showRoom() {
    el("home").classList.add("hidden");
    el("room").classList.remove("hidden");
  }

  function generateRoomId() {
    return "room-" + Math.random().toString(36).slice(2, 8);
  }

  el("createBtn").addEventListener("click", () => {
    const name = el("username").value.trim();
    if (!name) return alert("Ingresa un nombre de usuario");
    user = name; room = generateRoomId(); enterRoom();
  });

  el("joinBtn").addEventListener("click", () => {
    const name = el("username").value.trim();
    if (!name) return alert("Ingresa un nombre de usuario");
    const r = el("roomInput").value.trim();
    if (!r) return alert("Ingresa el c√≥digo de sala");
    user = name; room = r; enterRoom();
  });

  el("leaveBtn").addEventListener("click", () => {
    if (confirm("Salir de la sala?")) showHome();
  });

  el("resetBtn").addEventListener("click", () => ws?.send(JSON.stringify({ type: "reset" })));
  el("setTitleBtn").addEventListener("click", () => {
    const title = el("titleInput").value.trim();
    if (!title) return alert("Escribe un t√≠tulo para la historia");
    ws?.send(JSON.stringify({ type: "set_title", title }));
  });

  function renderButtons(available) {
    const container = el("buttons"); container.innerHTML = "";
    FIB.forEach((v) => {
      const btn = document.createElement("button");
      btn.textContent = v;
      btn.className = "vote-btn";
      btn.disabled = available.indexOf(v) === -1;
      btn.onclick = () => ws?.send(JSON.stringify({ type: "vote", value: v }));
      container.appendChild(btn);
    });
  }

  function renderUsers(users) {
    const ul = el("usersList");
    ul.innerHTML = "";
    Object.entries(users).forEach(([u, info]) => {
      const div = document.createElement("div");
      div.className = "user-item";
      div.innerHTML = `<div>${u}</div><div>${info.vote ?? "‚Äî"}</div>`;
      ul.appendChild(div);
    });
  }

  function renderHistory(history) {
    const list = el("historyList");
    list.innerHTML = "";
    if (!history || history.length === 0) {
      list.innerHTML = `<div class="small">A√∫n sin votaciones previas</div>`;
      return;
    }
    history.slice().reverse().forEach((h) => {
      const div = document.createElement("div");
      div.className = "history-item";
      const votes = Object.entries(h.results || {}).map(([k, v]) => `${k}: ${v}`).join(", ");
      div.innerHTML = `<div class="history-title">${h.title}</div><div class="history-votes">${votes || "Sin votos"}</div>`;
      list.appendChild(div);
    });
  }

  function connectWS() {
    const url = `${wsProtocol}://${backendHost}/ws?room=${encodeURIComponent(room)}&user=${encodeURIComponent(user)}`;
    console.log("Conectando a", url);
    ws = new WebSocket(url);

    ws.onopen = () => {
      el("roomId").textContent = room;
      el("me").textContent = user;
      showRoom();
      ws.send(JSON.stringify({ type: "request_state" }));
    };

    ws.onmessage = (ev) => {
      try { handleMsg(JSON.parse(ev.data)); } catch { console.error("Mensaje inv√°lido", ev.data); }
    };

    ws.onclose = () => console.warn("üîå Conexi√≥n cerrada");
    ws.onerror = (e) => { console.error("‚ùå Error WS:", e); alert("Error de conexi√≥n con el backend"); };
  }

  function handleMsg(msg) {
    if (!msg?.type) return;
    if (["state","joined","vote","reset","left","title_set"].includes(msg.type)) {
      const state = msg.state;
      console.log(msg);
      renderUsers(state.users);
      renderButtons(state.available);
      el("titleInput").value = state.title || "";
      el("titleRoom").textContent = state.title ? `Historia: ${state.title}` : "Sin t√≠tulo";
      updateChart(msg.state);
      renderHistory(state.history);
    } else if (msg.type === "error") alert("Error: " + msg.msg);
  }

  function enterRoom() { connectWS(); }

  // soporte para /room/<id>?user=...
  (function directLink() {
    const parts = location.pathname.split("/");
    if (parts.length >= 3 && parts[1] === "room") {
      const rid = decodeURIComponent(parts[2]);
      const u = new URLSearchParams(location.search).get("user");
      if (rid && u) { user = u; room = rid; el("username").value = u; el("roomInput").value = rid; enterRoom(); }
    }
  })();

  ["username","roomInput"].forEach((id) => {
    el(id).addEventListener("keydown",(e)=>{ if(e.key==="Enter") el("joinBtn").click(); });
  });

  // === üî• NUEVO BLOQUE: Monitoreo del backend ===
  function createBackendStatusElement() {
    const div = document.createElement("div");
    div.id = "backend-status";
    div.style.cssText = `
      padding: 8px 12px;
      border-radius: 8px;
      text-align: center;
      font-family: sans-serif;
      background-color: #ccc;
      color: #333;
      width: fit-content;
      margin: 10px auto;
    `;
    div.textContent = "üîÑ Verificando backend...";
    document.body.prepend(div);
  }

  async function checkBackendHealth() {
    const backendHost = "backpesanding.onrender.com"; // sin http
    const protocol = window.location.protocol === "https:" ? "https" : "http";
    const wsProtocol = protocol === "https" ? "wss" : "ws";
    const statusEl = document.getElementById("backend-status");
    const httpProtocol = window.location.protocol === "https:" ? "https" : "http";
    const backendURL = `https://${backendHost}/health`;

    try {
      const res = await fetch(backendURL);
      if (!res.ok) throw new Error("Error HTTP");
      const data = await res.json();

      statusEl.textContent = "‚úÖ Servicio activo";
      statusEl.style.backgroundColor = "#28a745";
      statusEl.style.color = "#fff";
      console.log("Backend OK:", data.status || data.message);
    } catch (err) {
      console.error("‚ùå Backend no disponible:", err);
      statusEl.textContent = "‚ùå Backend no disponible";
      statusEl.style.backgroundColor = "#dc3545";
      statusEl.style.color = "#fff";
    }
  }

  // Crear indicador y revisar cada 10 segundos
  createBackendStatusElement();
  checkBackendHealth();
  setInterval(checkBackendHealth, 10000);
})();


const chart = Highcharts.chart("chartContainer", {
    chart: {
      type: "pie",
      backgroundColor: 'rgba(0, 0, 0, 0.1)'
    },
    title: {
      text: "Conteo de votos",
      style: { color: '#FFFFFF' }
    },
    series: [{
      name: "Votos",
      colorByPoint: true,
      data: []
    }],
    tooltip: {
      pointFormat: "<b>{point.y} votos ({point.percentage:.1f}%)</b>"
    },
    accessibility: {
      point: { valueSuffix: "%" }
    }
  });

  // === Funci√≥n para actualizar los datos del gr√°fico ===
  function updateChart(state) {
    if (!state || !state.counts) return;

    let data = Object.entries(state.counts).map(([key, value]) => ({
      name: key,
      y: value
    }));
    console.log('data',data)
    data = data.filter(d =>  d.y >0 );
    console.log('data2',data)
    // Agregar cantidad de no votantes si existe
    if (state.counts.no_votaron !== undefined) {
      data.push({ name: "No votaron", y: state.counts.no_votaron, color: "#ccc" });
    }
    
    chart.series[0].setData(data, true);
  }

  
</script>

</body>
</html>
